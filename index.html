<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Library Card Maker</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="stylesheet" href="styles.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
  </head>

<html>
<body>
<div id="section-to-print" class="convertable-toPng">
<div id="printElement">
<div class="cardImage" id="card">
    <img class="cardImage" id="ui" src="https://static.wikia.nocookie.net/arthur/images/4/47/Arthur_2_Song.jpg/revision/latest/scale-to-width-down/340?cb=20120518234116" width="322px" height="206px" alt="library card background image"/>
        <div class="barcode" id="barcode">
          <img id="barcode2"/>
            <div id="bc#">
              <p style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; margin-top: -15px; text-align: centre;">
                <span id="bcnum">00000 </span><span id="mid"> 00000</span>
                <span id="bold" style="font-size: 15px; font-weight: bold;"> 0000</span> </p>
            </div> 
        </div>
  </div>
</div>
</div>

<div> <p style="z-index: 3; font-family: Arial, Helvetica, sans-serif; font-size: 12px; margin-top:-30px">  tip - you can move the barcode</div></p>

<p>
  Your card number: <input type="number" id="cardNumber" onfocus="this.value=''" value="00000000000000">
  <button type="button" onclick="submitCardNumber()">Submit</button>
  </p>
  
  <p>
    Paste image url here: <input type="url" id="userImage" onfocus="this.value=''" value="https://static.wikia.nocookie.net/arthur/images/4/47/Arthur_2_Song.jpg">
    <button type="button" onclick="submitUserImage()">Submit</button>
  </p>

<div class="link">
  <button type="button" onClick="window.print()">Print your new card</a>
  <button type="button" onclick="setBroken()">Click if broken</button></p>
</div>

<div class="notes">
  <p>notes:</p>
  <p>v10 (feb 15 2021)</p>
  <p> - barcodes generated with <a href="https://github.com/lindell/JsBarcode" target="_blank">jsbarcode library </a> </p>
  <p> - print function uses <a href="https://html2canvas.hertzen.com/" target="_blank">html2canvas </a></p>
  <p> - uses CODE128 style barcodes. libraries are supposed to use Codabar format, but I couldn't get them to scan??</p>
  <p>to do: uploading images? (probably not going to do this)</p>
  <p>to do: fix ios drag barcode movement</p>
  <p> - if you want to help, get in touch! g9f605++@++hot++mail++dot++calm</p>
</div>

</body>

<script>

let clickOnBC = false;
let currentX;
let currentY;
var cardNumber
const bc = document.getElementById("barcode");

bc.addEventListener('mousedown', mouseDown);
addEventListener('mouseup', mouseUp);
addEventListener('mousemove', mouseMove);

function mouseDown(e) {
  clickOnBC = true;
  e.preventDefault();
  bc.classList.add('active');
  clickOnBC = true;
}

function mouseUp(e) {
  clickOnBC = false;
  bc.classList.remove('active');
}

function mouseMove(e) {
  if (clickOnBC == false) {
    return;
  }
  currentX = e.pageX;
  currentY = e.pageY;
  bc.style.left = currentX - 80 + 'px';
  bc.style.top = currentY -250 + 'px';
}

var element = document.getElementById("barcode2");
JsBarcode(element, 1234567890123, {
    format: "CODE128",
    width:2,
    height:30,
    displayValue: false
    }
  );


function submitCardNumber(){
  var newCardNumber = document.getElementById('cardNumber').value;
  var newCardNumberString = newCardNumber.toString();
  document.getElementById('bcnum').innerHTML = newCardNumberString.slice(0,5);
  document.getElementById('mid').innerHTML = ' '  + newCardNumberString.slice(5,10);
  document.getElementById('bold').innerHTML = ' ' + newCardNumberString.slice(10,14);
  // var element = document.getElementById("barcode2");
  JsBarcode(element, newCardNumber, {
    format: "CODE128",
    width:2,
    height:30,
    displayValue: false
    }
  );
}

function submitUserImage(userImage) {
  var userImage = document.getElementById("userImage").value;
  document.getElementById("ui").src = userImage;
}

function setBroken() {
  window.location = "broken.html"
}

/* not gonna lie - no idea how this works! copied script from codepen. uses jquery, no idea why plain js doesn't work*/

$("#toPng").click(function() {
        html2canvas($(".convertable-toPng"), {
            onrendered: function(canvas) {
              // Convert and download as image 
              var dataURL = canvas.toDataURL('image/png');
              var a = $("<a>")
                .attr("href", dataURL)
                .attr("download", "img.png")
                .appendTo("body");
              
              a[0].click();
              a.remove();
            },
            
          useCORS: true
        });
    });



/*  this won't render the underlying image for some reason D:
function printElement() {
  var element = document.getElementById("printElement");
  html2canvas(element, allowTaint="true", useCORS="true").then(function(canvas) {
  var img = canvas.toDataURL("image/png");
  document.write('<img src="'+img+'"/>');
});
} 

*/
</script>

</html>